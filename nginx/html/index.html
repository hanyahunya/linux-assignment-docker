<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>linux</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=시크릿키"></script>

  <script>
    // 지도 생성
    var map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(37.39411289930125, 126.95703000400661),
      zoom: 14
    });

    var infowindow = new naver.maps.InfoWindow();

    // 금액을 억 단위 + 만 단위로 변환하는 함수
    function formatDealAmount(amount) {
      const eok = Math.floor(amount / 10000);
      const man = amount % 10000;
      let result = '';
      if (eok > 0) result += eok + '억';
      if (man > 0) result += (result ? ' ' : '') + man + '만원';
      return result || '0만원';
    }

    // 데이터 요청
    fetch('/api/infos')
      .then(response => response.json())
      .then(data => {
        const markerMap = new Map(); // 좌표별 데이터 모음

        data.infos.forEach(info => {
          const key = `${info.latitude},${info.longitude}`;
          if (!markerMap.has(key)) {
            markerMap.set(key, []);
          }
          markerMap.get(key).push(info);
        });

        markerMap.forEach((infosAtPosition, key) => {
          const [lat, lng] = key.split(',').map(Number);
          const position = new naver.maps.LatLng(lat, lng);

          // 마커 생성
          const marker = new naver.maps.Marker({
            position: position,
            map: map
          });

          // 마커 클릭 시 정보창 표시
          naver.maps.Event.addListener(marker, 'click', function() {
          // 거래일 기준 최신순 정렬
          infosAtPosition.sort((a, b) => new Date(b.dealDay) - new Date(a.dealDay));

          let contentString = '<div style="padding:10px;line-height:1.5; max-height:200px; overflow-y:auto;">';
          infosAtPosition.forEach(info => {
            contentString += `
              <div style="margin-bottom:8px; border-bottom:1px solid #ccc; padding-bottom:5px;">
                <b>거래일:</b> ${info.dealDay}<br/>
                <b>거래금액:</b> ${formatDealAmount(info.dealAmount)}<br/>
                <b>면적:</b> ${info.excluUseAr}㎡<br/>
                <b>층:</b> ${info.floor}층<br/>
                <b>건축년도:</b> ${info.buildYear}<br/>
                <b>거래유형:</b> ${info.dealingGbn}
              </div>`;
          });
          contentString += '</div>';
          infowindow.setContent(contentString);
          infowindow.open(map, marker);
        });

        });
      })
      .catch(error => {
        console.error('데이터 불러오기 실패:', error);
      });

    // 지도 클릭 시 인포윈도우 닫기
    naver.maps.Event.addListener(map, 'click', function() {
      infowindow.close();
    });

  </script>
</body>
</html>
